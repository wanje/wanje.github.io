<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gulp使用 | Notebook</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="个人学习记录，资料收集备忘">
    
    <link rel="preload" href="/assets/css/0.styles.0621086d.css" as="style"><link rel="preload" href="/assets/js/app.c3337c89.js" as="script"><link rel="preload" href="/assets/js/2.8eecf2bf.js" as="script"><link rel="preload" href="/assets/js/35.18d31a5d.js" as="script"><link rel="prefetch" href="/assets/js/10.031bdac6.js"><link rel="prefetch" href="/assets/js/11.68419d50.js"><link rel="prefetch" href="/assets/js/12.a68c305d.js"><link rel="prefetch" href="/assets/js/13.9bb8aebb.js"><link rel="prefetch" href="/assets/js/14.a3d2b969.js"><link rel="prefetch" href="/assets/js/15.58a3159f.js"><link rel="prefetch" href="/assets/js/16.348b7114.js"><link rel="prefetch" href="/assets/js/17.d4751aa3.js"><link rel="prefetch" href="/assets/js/18.2f60c804.js"><link rel="prefetch" href="/assets/js/19.b8cd5c8b.js"><link rel="prefetch" href="/assets/js/20.6a5bdc73.js"><link rel="prefetch" href="/assets/js/21.e266397c.js"><link rel="prefetch" href="/assets/js/22.db1a60a2.js"><link rel="prefetch" href="/assets/js/23.b829b10d.js"><link rel="prefetch" href="/assets/js/24.24c9fda0.js"><link rel="prefetch" href="/assets/js/25.b673df3e.js"><link rel="prefetch" href="/assets/js/26.0735eea0.js"><link rel="prefetch" href="/assets/js/27.ab062bf8.js"><link rel="prefetch" href="/assets/js/28.6be05bdf.js"><link rel="prefetch" href="/assets/js/29.fabc5342.js"><link rel="prefetch" href="/assets/js/3.6f52db6c.js"><link rel="prefetch" href="/assets/js/30.cd3cd508.js"><link rel="prefetch" href="/assets/js/31.d98a0ff0.js"><link rel="prefetch" href="/assets/js/32.d6e6d7f0.js"><link rel="prefetch" href="/assets/js/33.47b4cf46.js"><link rel="prefetch" href="/assets/js/34.409e6d8e.js"><link rel="prefetch" href="/assets/js/36.54a9d70a.js"><link rel="prefetch" href="/assets/js/37.0b65686f.js"><link rel="prefetch" href="/assets/js/38.a0aa7f1d.js"><link rel="prefetch" href="/assets/js/39.3e9a8fde.js"><link rel="prefetch" href="/assets/js/4.48eda041.js"><link rel="prefetch" href="/assets/js/40.3d8f390f.js"><link rel="prefetch" href="/assets/js/41.84fa0544.js"><link rel="prefetch" href="/assets/js/42.5f71c291.js"><link rel="prefetch" href="/assets/js/43.4a981203.js"><link rel="prefetch" href="/assets/js/44.b34e6721.js"><link rel="prefetch" href="/assets/js/45.bc982fdc.js"><link rel="prefetch" href="/assets/js/46.e46fc264.js"><link rel="prefetch" href="/assets/js/47.3b39b945.js"><link rel="prefetch" href="/assets/js/48.d244cb13.js"><link rel="prefetch" href="/assets/js/49.f370ffa4.js"><link rel="prefetch" href="/assets/js/5.2b92acf9.js"><link rel="prefetch" href="/assets/js/50.8aeab835.js"><link rel="prefetch" href="/assets/js/51.d56714ae.js"><link rel="prefetch" href="/assets/js/52.57597e7c.js"><link rel="prefetch" href="/assets/js/53.0bd1cb9c.js"><link rel="prefetch" href="/assets/js/54.58d79c8b.js"><link rel="prefetch" href="/assets/js/55.d609919f.js"><link rel="prefetch" href="/assets/js/56.cbe93b63.js"><link rel="prefetch" href="/assets/js/57.e1154be3.js"><link rel="prefetch" href="/assets/js/58.4b9344ba.js"><link rel="prefetch" href="/assets/js/59.8bd24db9.js"><link rel="prefetch" href="/assets/js/6.a8a356f6.js"><link rel="prefetch" href="/assets/js/60.845efb11.js"><link rel="prefetch" href="/assets/js/61.967fe233.js"><link rel="prefetch" href="/assets/js/62.f2cd1454.js"><link rel="prefetch" href="/assets/js/63.1414066e.js"><link rel="prefetch" href="/assets/js/64.7b93af6a.js"><link rel="prefetch" href="/assets/js/65.64efff88.js"><link rel="prefetch" href="/assets/js/66.34d8caa5.js"><link rel="prefetch" href="/assets/js/7.9ca531f8.js"><link rel="prefetch" href="/assets/js/8.5d1fdd4d.js"><link rel="prefetch" href="/assets/js/9.adbb7daa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0621086d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Notebook" class="logo"> <span class="site-name can-hide">Notebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记分类" class="dropdown-title"><span class="title">笔记分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记分类" class="mobile-dropdown-title"><span class="title">笔记分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  CSS
</a></li></ul></div></div><div class="nav-item"><a href="http://wanje.gitee.io/learning_notes/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更多
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记分类" class="dropdown-title"><span class="title">笔记分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记分类" class="mobile-dropdown-title"><span class="title">笔记分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  CSS
</a></li></ul></div></div><div class="nav-item"><a href="http://wanje.gitee.io/learning_notes/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更多
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTML</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/html/a标签的各种用途.html" class="sidebar-link">a标签的各种用途</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/js/JS零散集.html" class="sidebar-link">JS零散集</a></li><li><a href="/js/数据类型概览.html" class="sidebar-link">JS数据类型概览</a></li><li><a href="/js/WebComponents.html" class="sidebar-link">Web Components</a></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>ES6+</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/js/es6+/Class.html" class="sidebar-link">Class</a></li><li><a href="/js/es6+/Promise.html" class="sidebar-link">Promise</a></li><li><a href="/js/es6+/async-await.html" class="sidebar-link">async/await</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/css/CSS零散集.html" class="sidebar-link">CSS零散集</a></li><li><a href="/css/scss语法.html" class="sidebar-link">SCSS基础语法</a></li><li><a href="/css/flex弹性布局.html" class="sidebar-link">flex弹性布局</a></li><li><a href="/css/CSS选择器世界.html" class="sidebar-link">CSS选择器世界</a></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>CSS世界</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/css/CSS世界/层叠规则.html" class="sidebar-link">层叠规则</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>绘图&amp;动画</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/draw-animation/D3js.html" class="sidebar-link">D3.js</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Threejs开发指南</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/vue工程配置.html" class="sidebar-link">Vue工程创建及配置</a></li><li><a href="/vue/vue基础语法.html" class="sidebar-link">Vue基础语法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react工程配置.html" class="sidebar-link">React工程创建及配置</a></li><li><a href="/react/react基础语法.html" class="sidebar-link">React基础语法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>TypeScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/typescript/类型/为什么需要类型.html" class="sidebar-link">为什么需要类型</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>类型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>泛型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>类型转换</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/typescript/模块/CommonJS兼容模块.html" class="sidebar-link">CommonJS兼容模块</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>命名空间</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>理解声明</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node/Node模块机制.html" class="sidebar-link">Node模块机制与NPM包</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/webpack/webpack4.x笔记.html" class="sidebar-link">webpack4.x笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Python</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/python基础语法.html" class="sidebar-link">Python基础语法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/others/Markdown语法.html" class="sidebar-link">Markdown语法</a></li><li><a href="/others/Git使用.html" class="sidebar-link">Git使用</a></li><li><a href="/others/Gulp使用.html" class="active sidebar-link">Gulp使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#安装及初始化" class="sidebar-link">安装及初始化</a></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#gulpfile-js文件" class="sidebar-link">gulpfile.js文件</a></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#任务导出与组合" class="sidebar-link">任务导出与组合</a></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#异步执行" class="sidebar-link">异步执行</a></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#处理文件" class="sidebar-link">处理文件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#glob文件匹配规则" class="sidebar-link">glob文件匹配规则</a></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#向流-stream-中添加文件-合并文件" class="sidebar-link">向流(stream)中添加文件(合并文件)</a></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#分阶段输出-不同状态的文件" class="sidebar-link">分阶段输出(不同状态的文件)</a></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#src方法的三种工作模式-缓冲、流动、空" class="sidebar-link">src方法的三种工作模式(缓冲、流动、空)</a></li></ul></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#使用插件" class="sidebar-link">使用插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#条件插件" class="sidebar-link">条件插件</a></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#内联插件" class="sidebar-link">内联插件</a></li></ul></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#文件监控" class="sidebar-link">文件监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#可监控的事件-哪些行为触发任务" class="sidebar-link">可监控的事件(哪些行为触发任务)</a></li><li class="sidebar-sub-header"><a href="/others/Gulp使用.html#初始-队列-延迟执行" class="sidebar-link">初始/队列/延迟执行</a></li></ul></li></ul></li><li><a href="/others/环境&amp;软件安装.html" class="sidebar-link">环境&amp;软件安装</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gulp使用"><a href="#gulp使用" class="header-anchor">#</a> Gulp使用</h1> <p></p><div class="table-of-contents"><ul><li><a href="#安装及初始化">安装及初始化</a></li><li><a href="#gulpfile-js文件">gulpfile.js文件</a></li><li><a href="#任务导出与组合">任务导出与组合</a></li><li><a href="#异步执行">异步执行</a></li><li><a href="#处理文件">处理文件</a><ul><li><a href="#glob文件匹配规则">glob文件匹配规则</a></li><li><a href="#向流-stream-中添加文件-合并文件">向流(stream)中添加文件(合并文件)</a></li><li><a href="#分阶段输出-不同状态的文件">分阶段输出(不同状态的文件)</a></li><li><a href="#src方法的三种工作模式-缓冲、流动、空">src方法的三种工作模式(缓冲、流动、空)</a></li></ul></li><li><a href="#使用插件">使用插件</a><ul><li><a href="#条件插件">条件插件</a></li><li><a href="#内联插件">内联插件</a></li></ul></li><li><a href="#文件监控">文件监控</a><ul><li><a href="#可监控的事件-哪些行为触发任务">可监控的事件(哪些行为触发任务)</a></li><li><a href="#初始-队列-延迟执行">初始/队列/延迟执行</a></li></ul></li></ul></div><p></p> <h2 id="安装及初始化"><a href="#安装及初始化" class="header-anchor">#</a> 安装及初始化</h2> <p>gulp是基于node实现的，所以必须要求有node环境。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> gulp-cli -g <span class="token comment"># 全局安装命令行（安装一次即可）</span>
<span class="token function">npm</span> <span class="token function">install</span> gulp -D <span class="token comment"># 项目开发依赖安装本地包（每个项目单独安装）</span>

gulp --help <span class="token comment"># 命令帮助查看</span>
gulp <span class="token comment"># 执行默认任务</span>
gulp <span class="token operator">&lt;</span>task<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>othertask<span class="token operator">&gt;</span> <span class="token comment"># 执行某任务或多个任务</span>
</code></pre></div><h2 id="gulpfile-js文件"><a href="#gulpfile-js文件" class="header-anchor">#</a> gulpfile.js文件</h2> <p><code>gulpfile.js</code>是项目根目录下定义所有gulp任务或其他相关逻辑处理的文件，该文件在运行<code>gulp</code>命令时会被自动加载。</p> <p>由于node的模块解析功能，所以我们也可以在根目录下创建一个同名的<code>gulpfile.js</code>目录(注意目录也要保留<code>.js</code>)，此时加载时，该目录中的<code>index.js</code>就将作为入口文件，这样我们就可以单独编写一些独立的任务(task)模块(文件)，然后通过node的导入<code>import</code>导出<code>exports</code>机制进行引用和关联。</p> <h2 id="任务导出与组合"><a href="#任务导出与组合" class="header-anchor">#</a> 任务导出与组合</h2> <p>任务（tasks）可以是 public（公开） 或 private（私有） 类型的。</p> <ul><li>公开任务（Public tasks）从 gulpfile 中被导出（export），可以通过<code>gulp</code>命令直接调用。</li> <li>私有任务（Private tasks）被设计为在内部使用，通常作为串行<code>series()</code>或并行<code>parallel()</code>组合的组成部分。</li></ul> <p>一个私有类型的任务在外观和行为上和其他任务是一样的，但是不能够被用户直接调用。如需将一个任务注册为公开类型的，只需从 gulpfile.js 中导出（export）即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> series <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// `clean`函数并未被导出，因此被认为是私有任务，它仍然可以被用在 `series()` 组合中</span>
<span class="token keyword">function</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 其他内容...</span>
  <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// `build`函数被导出了，因此它是一个公开任务，并且可以被`gulp`命令直接调用，它也仍然可以被用在`series()`或`parallel()`组合中。</span>
<span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 其他内容...</span>
  <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>build <span class="token operator">=</span> build<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> build<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Gulp提供了两种组合方法：<code>series()</code>和<code>parallel()</code>，允许将多个独立的任务组合为一个更大的操作。这两个方法都可以接受任意数目的任务(task)函数或已经组合的操作。且<code>series()</code>和<code>parallel()</code>可以互相嵌套至任意深度。</p> <ul><li>如果需要让多个任务(task)按顺序串行执行，则使用<code>series()</code>方法。</li> <li>如果需要让多个任务(task)同时并发执行，则使用<code>parallel()</code>方法。</li></ul> <p><code>series()</code>串行执行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> series <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 省略函数体具体内容</span>
<span class="token keyword">function</span> <span class="token function">transpile</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">bundle</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>transpile<span class="token punctuation">,</span> bundle<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>parallel()</code>并行执行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> parallel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 省略函数体具体内容</span>
<span class="token keyword">function</span> <span class="token function">javascript</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">css</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>build <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>javascript<span class="token punctuation">,</span> css<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当<code>series()</code>或<code>parallel()</code>被调用时，任务(tasks)才被组合在一起，这使得我们可以根据条件进行组合，而不需要在单个任务中进行条件判断。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> series <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">minify</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">transpile</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">livereload</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// 根据条件进行组合</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  exports<span class="token punctuation">.</span>build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>transpile<span class="token punctuation">,</span> minify<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  exports<span class="token punctuation">.</span>build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>transpile<span class="token punctuation">,</span> livereload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>series()</code>与<code>parallel()</code>可互相嵌套到任意深度。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> series parallel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">cssTranspile</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">cssMinify</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">jsTranspile</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">jsBundle</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">jsMinify</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// 任意嵌套</span>
exports<span class="token punctuation">.</span>build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>
  clean<span class="token punctuation">,</span>
  <span class="token function">parallel</span><span class="token punctuation">(</span>
    cssTranspile<span class="token punctuation">,</span>
    <span class="token function">series</span><span class="token punctuation">(</span>jsTranspile<span class="token punctuation">,</span> jsBundle<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">parallel</span><span class="token punctuation">(</span>cssMinify<span class="token punctuation">,</span> jsMinify<span class="token punctuation">)</span><span class="token punctuation">,</span>
  publish
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当一个组合操作执行时，这个组合中的每一个任务每次被调用时都会被执行。例如，在两个不同的任务之间调用的<code>clean</code>任务，该<code>clean</code>任务将被执行两次，这可能导致不可预期的结果。因此，最好重构组合中的<code>clean</code>任务。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> series<span class="token punctuation">,</span> parallel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> javascript <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>build <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>css<span class="token punctuation">,</span> javascript<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// css和javascript中将分别执行一次clean，导致一次并行任务执行了两次clean</span>

<span class="token comment">// 可将上面代码重构为如下：</span>

<span class="token keyword">function</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">css</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">javascript</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>css<span class="token punctuation">,</span> javascript<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="异步执行"><a href="#异步执行" class="header-anchor">#</a> 异步执行</h2> <p>node中有多种处理异步功能的方式，常见的就是“错误信息优先”的回调模式，除此之外还会有<code>stream(数据流)</code>、<code>promise</code>、<code>event emitter(事件触发器)</code>、<code>child process(子进程)</code>和<code>observable(观察者)</code>这些异步操作或结果。</p> <p>gulp通过任务(task)的返回结果统一规范化了所有这些类型的异步功能。当从任务中返回上面提到的异步操作或结果时，成功或错误值将通知<code>gulp</code>是否继续执行或结束。如果任务出错，<code>gulp</code>将立即结束执行并显示该错误。<strong>如果任务不返回任何内容，则必须使用callback回调来指示任务已完成。</strong></p> <p>当使用<code>series()</code>组合多个串行任务时，任何一个任务的错误都将导致整个任务组合结束，并且不会进一步执行其他任务。当使用<code>parallel()</code>组合多个并行任务时，一个任务的错误也将导致整个任务组合的结束，但是其他并行的任务可能会执行完，也可能没有执行完。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> EventEmitter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rxjs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 任务返回stream流</span>
<span class="token keyword">function</span> <span class="token function">streamTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'*.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'output'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 任务返回Promise</span>
<span class="token keyword">function</span> <span class="token function">promiseTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'某值'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 任务返回event emitter事件触发器</span>
<span class="token keyword">function</span> <span class="token function">eventEmitterTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 事件必须在异步操作中触发，否则gulp监听不到</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> emitter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 任务返回child progress子进程</span>
<span class="token keyword">function</span> <span class="token function">childProcessTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 任务返回observable观察者</span>
<span class="token keyword">function</span> <span class="token function">observableTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Observable<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 不返回任何内容则必须使用callback回调来指示任务已完成</span>
<span class="token keyword">function</span> <span class="token function">callbackTask</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// `cb()` 要放在某异步操作中调用</span>
  <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如需通过callback把任务中的错误告知gulp，则应将Error实例作为callback的唯一参数</span>
  <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error msg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 但是，我们通常会将此callback函数传递给另一个API ，而不是自己调用它</span>
  fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">'gulpfile.js'</span><span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>gulp不再支持同步任务</strong>，必须使用callback回调或返回上面提到的一种异步操作或结果。
如果不使用前面提供到几种方式，你还可以<strong>将任务定义为一个<code>async</code>函数</strong>，它将利用<code>promise</code>对你的任务进行包装(相当于包装成异步任务)。这将允许你使用<code>await</code>处理<code>promise</code>，并使用其他同步代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">asyncAwaitTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> version <span class="token punctuation">}</span> <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'some result'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>default <span class="token operator">=</span> asyncAwaitTask<span class="token punctuation">;</span>
</code></pre></div><h2 id="处理文件"><a href="#处理文件" class="header-anchor">#</a> 处理文件</h2> <p>gulp暴露了<code>src()</code>和<code>dest()</code>方法用于处理计算机上存放的文件。<strong><code>src()</code>是文件输入的入口，<code>dest()</code>是文件输出的出口。</strong></p> <p><code>src()</code>接受<strong>glob参数(类似git中添加要忽略的文件匹配规则)</strong>，该参数<strong>可以是一条匹配规则字符串或多条组成的数组</strong>，并从文件系统中读取文件然后生成一个Node流(stream)，它将所有匹配的文件读取到内存中并通过流(stream)进行处理(通过流在各操作中进行处理)；<strong>由<code>src()</code>产生的流应当从任务中返回</strong>并发出异步完成的信号(符合上面返回stream的异步操作情况)。</p> <p><code>dest()</code>接受一个<strong>输出目录作为参数</strong>，它也会产生一个Node流(stream)，可继续往下流转，但通常其都作为终止流(即最后一步)。当它接收到通过管道(pipeline)传输的文件时，它会<strong>将文件内容及文件属性写入到指定的目录中</strong>。gulp还提供了<code>symlink()</code>方法，其操作方式类似<code>dest()</code>，但创建的是链接而不是文件。</p> <p>数据流(stream)所提供的主要的API是<code>.pipe()</code>方法，用于<strong>连接转换流(Transform streams)或可写流(Writable streams)</strong>。大多数情况下，<strong>利用<code>.pipe()</code>方法将插件放置在<code>src()</code>和<code>dest()</code>之间</strong>，并转换流(stream)中的文件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-babel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">copy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'output/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 直接将目标文件流转输出到某个目录下，相当于复制文件</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">babelTransform</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 将目标文件经过babel转译后输出到指定目录</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'output/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="glob文件匹配规则"><a href="#glob文件匹配规则" class="header-anchor">#</a> glob文件匹配规则</h3> <p>glob文件路径匹配规则类似在git的<code>.gitignore</code>中添加忽略文件匹配，其由普通字符、分隔符<code>/</code>、通配符<code>*</code>、取反<code>!</code>组成。在<code>src()</code>方法中<code>glob</code>参数可以是一个字符串，也可以是多个字符串组成的数组，但不管是字符串还是数组，都至少要匹配到一个文件，否则<code>src()</code>方法将报错。当glob使用数组时，将按照数组中规则的顺序依次匹配，这对于取反glob很有用（数组项为并列or或关系，但其中的取反项为and与关系，<strong>取反为排除前一项中匹配到的</strong>）。</p> <ul><li><strong><code>/</code>斜杠，分隔符</strong>，用于分隔字符串路径片段，<strong>字符串片段是指两个分隔符之间的所有字符组成的字符串</strong>(除首尾可能无分隔符)。注意：两个反斜杆<code>\\</code>被保留作为转义符使用。</li> <li><strong><code>*</code>一个星号</strong>，用于<b class="color-warning">一个字符串片段中</b>匹配任意数量的字符，包括零个匹配。其只能匹配单级目录下的文件，如<code>*.js</code>可匹配<code>index.js</code>，但不能匹配<code>scripts/index.js</code>这样目录下的文件，即只能匹配一个字符串片段，不能匹配存在多个片段的路径。</li> <li><strong><code>**</code>两个星号</strong>，用于<b class="color-warning">多个字符串片段中</b>匹配任意数量的字符，包括零个匹配。其可以匹配多层嵌套目录下的内容，如<code>pub-ui/js/**/*.js</code>可匹配<code>pub-ui/js/index.js</code>、<code>pub-ui/js/nested/index.js</code>和<code>pub-ui/js/nested/twice/index.js</code>。<b class="color-danger">注意：</b>应尽量限制两个星号的匹配范围，比如路径前限制在某目录下，避免匹配大量不必要的目录，如上面的例子若前面不限制<code>pub-ui/js/</code>这个范围，则项目中<code>node_modules</code>目录下的所有js文件也将全都匹配。</li> <li><strong><code>!</code>感叹号，取反</strong>，用于排除前面紧邻的集合中的一些匹配项。数组参数中是按照数组元素顺序依次进行匹配操作的，默认所有的匹配是并集关系，只有取反操作可以排除前一项匹配到的集合，其后也还可以再添加匹配项(可以把排除的集合中部分特殊的再添加进来)。取反也可以作为两个星号<code>**</code>匹配的限制，比如上面不限制<code>pub-ui/js/</code>时，使用取反来排除<code>node_modules</code>目录：<code>['**/*.js', '!node_modules/']</code>。<b class="color-danger">注意：</b>使用取反排除时由普通字符组成的匹配规则字符串，执行效率是最高的，可直接排除整个目录的，规则就不用精确到某一类文件，如前面排除<code>node_modules</code>中js文件时，完全没必要使用<code>!node_modules/**/*.js</code>的匹配方式，否则每个匹配项都要与该规则进行比较，将导致执行速度极慢。</li></ul> <p><b class="color-warning">关于匹配重叠：</b>多条glob规则匹配到相同的文件就是匹配重叠，在同一个<code>src()</code>中glob匹配重叠的部分，gulp会自动尽力去重，一般也不会造成重复执行问题；但是多个<code>src()</code>调用时若产生glob匹配重叠，gulp是不会自动去重的，所以要组织好各任务的执行顺序(串行还是并行，同一类文件的处理可以放在一个组合任务中避免交叉)。</p> <h3 id="向流-stream-中添加文件-合并文件"><a href="#向流-stream-中添加文件-合并文件" class="header-anchor">#</a> 向流(stream)中添加文件(合并文件)</h3> <p><code>src()</code>也可放在管道(pipeline)的中间，以根据给定的glob向流中添加新的流(文件)。<strong>新加入的文件只对后续的转换可用</strong>。若glob匹配的文件与之前的有重复，仍然会再次添加文件。
这对于在添加普通的JS文件之前先转换部分文件的场景很有用，如添加新的文件后可以对所有文件统一进行压缩混淆(uglifying)。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-babel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uglify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-uglify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 对匹配的文件进行babel转译</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'vendor/*.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 与匹配的第三方文件合并</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 压缩混淆</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'output/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="分阶段输出-不同状态的文件"><a href="#分阶段输出-不同状态的文件" class="header-anchor">#</a> 分阶段输出(不同状态的文件)</h3> <p><code>dest()</code>也可以用在管道中间用于将文件的中间状态输出到文件系统。当接收到一个文件时，当前状态的该文件将被写入文件系统，然后还可以让该文件继续沿着管道(pipeline)传输。
此功能可用于在同一个管道中创建未压缩(unminified)和已压缩(minified)的文件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-babel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uglify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-uglify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rename <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-rename'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'vendor/*.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'output/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 输出转译合并后的未压缩文件</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extname<span class="token operator">:</span> <span class="token string">'.min.js'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'output/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出压缩混淆并重命名后的文件</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="src方法的三种工作模式-缓冲、流动、空"><a href="#src方法的三种工作模式-缓冲、流动、空" class="header-anchor">#</a> src方法的三种工作模式(缓冲、流动、空)</h3> <p><code>src()</code>可以工作在三种模式下：缓冲(buffering)、流动(streaming)、空(empty)。这些模式可以通过对<code>src()</code>的 <strong><code>buffer</code>和<code>read</code>参数进行<a href="https://www.gulpjs.com.cn/docs/api/src/#options" target="_blank" rel="noopener noreferrer">设置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong>。</p> <ul><li><strong>缓冲（Buffering）模式是默认模式，将文件内容加载在内存中</strong>。插件通常运行在缓冲模式下，并且许多插件不支持流动(streaming)模式。</li> <li><strong>流动（Streaming）模式(不是指数据流)的存在主要用于操作无法放入内存中的大文件</strong>，例如巨幅图像或电影。文件内容从文件系统中以小块的方式流式传输，而不是一次性全部加载。如果需要流动模式，需要查找支持此模式的插件或自己编写。</li> <li><strong>空（Empty）模式不包含任何内容，仅在处理文件元数据时有用</strong>。</li></ul> <h2 id="使用插件"><a href="#使用插件" class="header-anchor">#</a> 使用插件</h2> <p>gulp插件实质上是对Node流进行转换，插件封装了通过管道(pipeline)转换文件的常见功能，通常是使用<code>.pipe()</code>方法并放在<code>src()</code>和<code>dest()</code>之间，它们可以更改经过流(stream)的每个文件的文件名、元数据或文件内容。</p> <p>托管在npm上的gulp插件标有“gulpplugin”和“gulpfriendly”关键字，也可以在gulp官网<a href="https://gulpjs.com/plugins/" target="_blank" rel="noopener noreferrer">插件搜索页<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>查找。每个插件应当只完成必要的工作，要获得想要的结果可能需要把一组插件组合在一起使用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uglify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-uglify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rename <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-rename'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// gulp-uglify 插件压缩文件但并不改变文件名</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extname<span class="token operator">:</span> <span class="token string">'.min.js'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 使用 gulp-rename 插件修改文件的扩展名</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'output/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>并非gulp中的所有都需要用插件来完成，虽说插件是一种快速上手的方法，但许多操作都应该使用独立的功能模块或库来实现。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 直接使用现成的rollup库来实现js打包操作，而不是使用其他各种插件拼凑</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> rollup <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rollup'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Rollup提供了基于promise的API，在`async`异步任务中工作得很好</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token keyword">await</span> rollup<span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> <span class="token string">'src/index.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> bundle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 返回的一个promise</span>
    file<span class="token operator">:</span> <span class="token string">'output/bundle.js'</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'iife'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>插件应该总是用来转换文件的，其他操作都应该使用(非插件的)node模块或库来实现。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'delete'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 直接使用`delete`模块，避免使用gulp-rimraf插件</span>
  <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'output/*.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="条件插件"><a href="#条件插件" class="header-anchor">#</a> 条件插件</h3> <p>因为插件的操作不应该针对特定文件类型(但有些插件确实是针对某一类型文件的，如babel)，所以在同一管道任务中我们可能需要使用像<code>gulp-if</code>之类的条件插件来完成转换某些文件的操作。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gulpif <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-if'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uglify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-uglify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">isJS</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断文件的扩展名是否是'.js'</span>
  <span class="token keyword">return</span> file<span class="token punctuation">.</span>extname <span class="token operator">===</span> <span class="token string">'.js'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在同一个管道上处理 JS 和 CSS 文件</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'src/*.js'</span><span class="token punctuation">,</span> <span class="token string">'src/*.css'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">gulpif</span><span class="token punctuation">(</span>isJS<span class="token punctuation">,</span> <span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 只对JS文件应用gulp-uglify插件</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'output/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="内联插件"><a href="#内联插件" class="header-anchor">#</a> 内联插件</h3> <p>内联插件是一次性的转换流(Transform Streams)，可以通过在<code>gulpfile.js</code>文件直接书写需要的功能(也就是自己写一个本地gulp插件)。在两种情况下，创建内联插件很有用：</p> <ul><li>避免自己创建并维护一个插件(按gulp独立插件开发规范开发并发布的)。</li> <li>避免fork一个已存在的插件并再添加自己所需的功能。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uglify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglify-js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用于压缩文件</span>
<span class="token keyword">const</span> through2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'through2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用于创建一个转换流（替代Node自带的stream API）</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.js'</span><span class="token punctuation">)</span>
    <span class="token comment">// 使用一些基础工具包自己创建一个内联插件，从而避免使用 gulp-uglify 插件</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>through2<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> _<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> code <span class="token operator">=</span> uglify<span class="token punctuation">.</span><span class="token function">minify</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>contents<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        file<span class="token punctuation">.</span>contents <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'output/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="文件监控"><a href="#文件监控" class="header-anchor">#</a> 文件监控</h2> <p>gulp API中的<code>watch()</code>方法利用文件系统的监控程序将globs匹配的文件的变动与任务进行关联，<strong>当监控的文件被修改，就自动执行关联的任务</strong>，若被执行的任务没有触发异步完成信号，则该任务将不会再次运行(相当于上次的任务一直未完成，从而不会开始新的一次该任务)。该方法还提供了内置的延迟和排队机制。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> watch<span class="token punctuation">,</span> series <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">javascript</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">css</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// 只关联一个任务</span>
<span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.css'</span><span class="token punctuation">,</span> css<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 关联一个任务组合</span>
<span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.js'</span><span class="token punctuation">,</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> javascript<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>监控关联的任务要<strong class="color-danger">避免同步任务：</strong>如果将同步任务关联到监控程序，则无法确定任务的完成情况，任务将不会再次运行。</p> <p>由于文件监控程序会让Node进程保持持续运行，因此不会有错误或警告产生，由于进程没有退出，因此也无法确定任务是否已经完成还是运行了很久很久了。</p> <h3 id="可监控的事件-哪些行为触发任务"><a href="#可监控的事件-哪些行为触发任务" class="header-anchor">#</a> 可监控的事件(哪些行为触发任务)</h3> <p>默认情况下，只要<strong>创建、更改或删除</strong>文件，文件监控程序就会执行关联的任务。 如果你需要使用不同的事件(<strong>发生指定行为时才执行任务</strong>)，可以在<strong>调用<code>watch()</code>方法时通过<code>events</code>参数进行指定</strong>。可用的事件有<code>add(添加文件)</code>、<code>addDir(添加文件夹)</code>、<code>change(文件更改)</code>、<code>unlink</code>、<code>unlinkDir</code>、<code>ready</code>、<code>error</code>。此外，还有一个<code>all</code>事件，它表示除<code>ready</code>和<code>error</code>之外的所有事件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 所有事件都将被监控</span>
<span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> events<span class="token operator">:</span> <span class="token string">'all'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="初始-队列-延迟执行"><a href="#初始-队列-延迟执行" class="header-anchor">#</a> 初始/队列/延迟执行</h3> <p>调用<code>watch()</code>之后，<strong>关联的任务默认是不会被立即执行的</strong>，而是要等到第一次文件修之后才执行，若要在调用<code>watch()</code>之后就<strong>立即执行一次，则可将<code>ignoreInitial</code>参数设置为<code>false</code></strong>。</p> <p><code>watch()</code>方法<strong>默认情况下能够保证当前执行的任务不会再次并发执行(而是队列执行)</strong>。当关联的任务正在运行时又有文件被修改了，那么所关联任务的这次新的执行将被放到执行队列中等待，直到上一次关联任务执行完之后才能运行。每一次文件修改只产生一次关联任务的执行并放入队列中。<strong>若需要禁止队列，可将<code>queue</code>参数设置为<code>false</code></strong>（若出现并发执行可能导致结果错乱）。</p> <p><strong>默认情况下，文件更改后经过200毫秒延迟，所关联的任务才会执行</strong>。这是为了避免在同时更改许多文件时(如查替换操作)过早启动任务的执行。若需要调整延迟时间，可通过<code>delay</code>参数设置延迟毫秒数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.js'</span><span class="token punctuation">,</span> 
  <span class="token punctuation">{</span>
    ignoreInitial<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 调用watch就立即执行一次（将忽略初始化这一选项置为false）</span>
    queue<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 取消队列执行，可能出现并发执行可能导致结果错乱，所以最好不要取消队列</span>
    delay<span class="token operator">:</span> <span class="token number">500</span>  <span class="token comment">// 延迟500ms才执行关联任务，避免文件(或多个文件)短时间内还未修改完就开海执行任务了</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/others/Git使用.html" class="prev">
        Git使用
      </a></span> <span class="next"><a href="/others/环境&amp;软件安装.html">
        环境&amp;软件安装
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c3337c89.js" defer></script><script src="/assets/js/2.8eecf2bf.js" defer></script><script src="/assets/js/35.18d31a5d.js" defer></script>
  </body>
</html>
