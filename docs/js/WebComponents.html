<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Web Components | Notebook</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/docs/favicon.ico">
    <meta name="description" content="个人学习记录，资料收集备忘">
    
    <link rel="preload" href="/docs/assets/css/0.styles.89b5ee64.css" as="style"><link rel="preload" href="/docs/assets/js/app.1b6c3a36.js" as="script"><link rel="preload" href="/docs/assets/js/2.3ed89261.js" as="script"><link rel="preload" href="/docs/assets/js/32.ff30ecee.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.d75f7532.js"><link rel="prefetch" href="/docs/assets/js/11.c425bedb.js"><link rel="prefetch" href="/docs/assets/js/12.cac19daf.js"><link rel="prefetch" href="/docs/assets/js/13.1d034024.js"><link rel="prefetch" href="/docs/assets/js/14.bde6313a.js"><link rel="prefetch" href="/docs/assets/js/15.1f6d8631.js"><link rel="prefetch" href="/docs/assets/js/16.5cb9577b.js"><link rel="prefetch" href="/docs/assets/js/17.3beef25d.js"><link rel="prefetch" href="/docs/assets/js/18.fb379ed6.js"><link rel="prefetch" href="/docs/assets/js/19.d7ad8859.js"><link rel="prefetch" href="/docs/assets/js/20.8ce4c47b.js"><link rel="prefetch" href="/docs/assets/js/21.4f91c87e.js"><link rel="prefetch" href="/docs/assets/js/22.e95d80aa.js"><link rel="prefetch" href="/docs/assets/js/23.fadb82c0.js"><link rel="prefetch" href="/docs/assets/js/24.fa1b3015.js"><link rel="prefetch" href="/docs/assets/js/25.e16a9423.js"><link rel="prefetch" href="/docs/assets/js/26.085b54ad.js"><link rel="prefetch" href="/docs/assets/js/27.c54b5bea.js"><link rel="prefetch" href="/docs/assets/js/28.9ab345e0.js"><link rel="prefetch" href="/docs/assets/js/29.44bbf18f.js"><link rel="prefetch" href="/docs/assets/js/3.7a31b6e0.js"><link rel="prefetch" href="/docs/assets/js/30.7635f89f.js"><link rel="prefetch" href="/docs/assets/js/31.f47adca1.js"><link rel="prefetch" href="/docs/assets/js/33.970e5c5c.js"><link rel="prefetch" href="/docs/assets/js/34.c5833f2d.js"><link rel="prefetch" href="/docs/assets/js/35.1c98ba46.js"><link rel="prefetch" href="/docs/assets/js/36.92f32b63.js"><link rel="prefetch" href="/docs/assets/js/37.fedc298d.js"><link rel="prefetch" href="/docs/assets/js/38.4bef4656.js"><link rel="prefetch" href="/docs/assets/js/39.43d1b106.js"><link rel="prefetch" href="/docs/assets/js/4.25702ad2.js"><link rel="prefetch" href="/docs/assets/js/40.7218a227.js"><link rel="prefetch" href="/docs/assets/js/41.c6721759.js"><link rel="prefetch" href="/docs/assets/js/42.1c85d75c.js"><link rel="prefetch" href="/docs/assets/js/43.8bd1225e.js"><link rel="prefetch" href="/docs/assets/js/44.3530ae28.js"><link rel="prefetch" href="/docs/assets/js/45.ffd25157.js"><link rel="prefetch" href="/docs/assets/js/46.420b4ed3.js"><link rel="prefetch" href="/docs/assets/js/47.8cd8194c.js"><link rel="prefetch" href="/docs/assets/js/48.2fcf1e32.js"><link rel="prefetch" href="/docs/assets/js/49.d04f96b1.js"><link rel="prefetch" href="/docs/assets/js/5.00c62753.js"><link rel="prefetch" href="/docs/assets/js/50.0d5e903c.js"><link rel="prefetch" href="/docs/assets/js/51.32963eb4.js"><link rel="prefetch" href="/docs/assets/js/52.61502fff.js"><link rel="prefetch" href="/docs/assets/js/53.b5ba8f44.js"><link rel="prefetch" href="/docs/assets/js/54.62e3aa04.js"><link rel="prefetch" href="/docs/assets/js/55.305e52f6.js"><link rel="prefetch" href="/docs/assets/js/56.54f7cbaf.js"><link rel="prefetch" href="/docs/assets/js/57.f321eb7c.js"><link rel="prefetch" href="/docs/assets/js/58.2cc9946d.js"><link rel="prefetch" href="/docs/assets/js/59.588ceaee.js"><link rel="prefetch" href="/docs/assets/js/6.5a12abd5.js"><link rel="prefetch" href="/docs/assets/js/60.1db881cb.js"><link rel="prefetch" href="/docs/assets/js/61.13f24fb8.js"><link rel="prefetch" href="/docs/assets/js/62.e385682e.js"><link rel="prefetch" href="/docs/assets/js/63.d11bc69f.js"><link rel="prefetch" href="/docs/assets/js/64.c80175e8.js"><link rel="prefetch" href="/docs/assets/js/65.50d2bb46.js"><link rel="prefetch" href="/docs/assets/js/66.fd4dcd4e.js"><link rel="prefetch" href="/docs/assets/js/67.3171ff37.js"><link rel="prefetch" href="/docs/assets/js/68.d68b48b5.js"><link rel="prefetch" href="/docs/assets/js/69.b2f48e4e.js"><link rel="prefetch" href="/docs/assets/js/7.4b570e0d.js"><link rel="prefetch" href="/docs/assets/js/70.8462ad22.js"><link rel="prefetch" href="/docs/assets/js/71.c3a74071.js"><link rel="prefetch" href="/docs/assets/js/72.0d692eb2.js"><link rel="prefetch" href="/docs/assets/js/73.545f341d.js"><link rel="prefetch" href="/docs/assets/js/74.14a0a768.js"><link rel="prefetch" href="/docs/assets/js/75.9a75fd06.js"><link rel="prefetch" href="/docs/assets/js/76.69875d9d.js"><link rel="prefetch" href="/docs/assets/js/77.28340622.js"><link rel="prefetch" href="/docs/assets/js/78.b0300766.js"><link rel="prefetch" href="/docs/assets/js/79.7a5df1be.js"><link rel="prefetch" href="/docs/assets/js/8.c7d47f3e.js"><link rel="prefetch" href="/docs/assets/js/9.b60e9130.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.89b5ee64.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="/docs/logo.png" alt="Notebook" class="logo"> <span class="site-name can-hide">Notebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记分类" class="dropdown-title"><span class="title">笔记分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记分类" class="mobile-dropdown-title"><span class="title">笔记分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/js/" class="nav-link router-link-active">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/docs/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/docs/css/" class="nav-link">
  CSS
</a></li></ul></div></div><div class="nav-item"><a href="https://wanje.github.io/demo_notes/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更多
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记分类" class="dropdown-title"><span class="title">笔记分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记分类" class="mobile-dropdown-title"><span class="title">笔记分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/js/" class="nav-link router-link-active">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/docs/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/docs/css/" class="nav-link">
  CSS
</a></li></ul></div></div><div class="nav-item"><a href="https://wanje.github.io/demo_notes/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更多
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTML</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/html/HTML零散集.html" class="sidebar-link">HTML零散集</a></li><li><a href="/docs/html/a标签的各种用途.html" class="sidebar-link">a标签的各种用途</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/js/JS错题本.html" class="sidebar-link">JS错题本</a></li><li><a href="/docs/js/JS零散集.html" class="sidebar-link">JS零散集</a></li><li><a href="/docs/js/数组Array.html" class="sidebar-link">数组Array</a></li><li><a href="/docs/js/字符串String.html" class="sidebar-link">字符串String</a></li><li><a href="/docs/js/计算Math.html" class="sidebar-link">计算Math</a></li><li><a href="/docs/js/事件Event.html" class="sidebar-link">事件Event</a></li><li><a href="/docs/js/WebComponents.html" aria-current="page" class="active sidebar-link">Web Components</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#custom-elements自定义元素" class="sidebar-link">Custom Elements自定义元素</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#关于渲染顺序" class="sidebar-link">关于渲染顺序</a></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#扩展内建-原生-元素" class="sidebar-link">扩展内建(原生)元素</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#shadow-dom-内部影子dom" class="sidebar-link">Shadow DOM 内部影子DOM</a></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#模板元素-template" class="sidebar-link">模板元素 template</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#插入模板内容" class="sidebar-link">插入模板内容</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#shadow-dom-插槽-组成" class="sidebar-link">Shadow DOM 插槽/组成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#插槽事件与api" class="sidebar-link">插槽事件与API</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#给-shadow-dom-添加样式" class="sidebar-link">给 Shadow DOM 添加样式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#host选择器" class="sidebar-link">:host选择器</a></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#host-选择器" class="sidebar-link">:host()选择器</a></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#host-context-选择器" class="sidebar-link">:host-context()选择器</a></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#插槽内容样式及-slotted" class="sidebar-link">插槽内容样式及::slotted()</a></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#使用自定义css变量传递样式" class="sidebar-link">使用自定义CSS变量传递样式</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#shadow-dom-与事件" class="sidebar-link">Shadow DOM 与事件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#shadow-dom-事件冒泡" class="sidebar-link">Shadow DOM 事件冒泡</a></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#event-composed" class="sidebar-link">event.composed</a></li><li class="sidebar-sub-header"><a href="/docs/js/WebComponents.html#customevent-自定义事件" class="sidebar-link">CustomEvent 自定义事件</a></li></ul></li></ul></li><li><a href="/docs/js/File文件API.html" class="sidebar-link">File文件API</a></li><li><a href="/docs/js/鼠标拖放与拖拽dnd.html" class="sidebar-link">鼠标拖拽与拖放</a></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>ES6+</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/js/es6+/Class.html" class="sidebar-link">Class</a></li><li><a href="/docs/js/es6+/Promise.html" class="sidebar-link">Promise</a></li><li><a href="/docs/js/es6+/async-await.html" class="sidebar-link">async/await</a></li><li><a href="/docs/js/es6+/Proxy.html" class="sidebar-link">Proxy</a></li><li><a href="/docs/js/es6+/Reflect.html" class="sidebar-link">Reflect</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/css/CSS零散集.html" class="sidebar-link">CSS零散集</a></li><li><a href="/docs/css/scss语法.html" class="sidebar-link">SCSS基础语法</a></li><li><a href="/docs/css/CSS选择器世界.html" class="sidebar-link">CSS选择器世界</a></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>CSS世界</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/css/CSS世界/层叠规则.html" class="sidebar-link">层叠规则</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>CSS新世界</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/css/CSS新世界/第6章.html" class="sidebar-link">第 6 章 全新的布局方式</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>绘图&amp;动画</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/draw-animation/D3js.html" class="sidebar-link">D3.js</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Threejs开发指南</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/vue/vue工程配置.html" class="sidebar-link">Vue工程创建及配置</a></li><li><a href="/docs/vue/vue基础语法.html" class="sidebar-link">Vue基础语法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/react/react工程配置.html" class="sidebar-link">React工程创建及配置</a></li><li><a href="/docs/react/react基础语法.html" class="sidebar-link">React基础语法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>TypeScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/typescript/类型/为什么需要类型.html" class="sidebar-link">为什么需要类型</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>类型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>泛型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>类型转换</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/docs/typescript/模块/CommonJS兼容模块.html" class="sidebar-link">CommonJS兼容模块</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>命名空间</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>理解声明</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/node/Node模块机制.html" class="sidebar-link">Node模块机制与NPM包</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/webpack/webpack4.x笔记.html" class="sidebar-link">webpack4.x笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Python</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/python/python基础语法.html" class="sidebar-link">Python基础语法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/others/参考内容.html" class="sidebar-link">参考内容</a></li><li><a href="/docs/others/Markdown语法.html" class="sidebar-link">Markdown语法</a></li><li><a href="/docs/others/Git使用.html" class="sidebar-link">Git使用</a></li><li><a href="/docs/others/Gulp使用.html" class="sidebar-link">Gulp使用</a></li><li><a href="/docs/others/Rollup使用.html" class="sidebar-link">Rollup使用</a></li><li><a href="/docs/others/Nginx配置.html" class="sidebar-link">Nginx基础配置与操作</a></li><li><a href="/docs/others/环境&amp;软件安装.html" class="sidebar-link">环境&amp;软件安装</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="web-components"><a href="#web-components" class="header-anchor">#</a> Web Components</h1> <p>Web Components 包含以下几大内容：</p> <ul><li>Custom elements —— 用于自定义 HTML 元素</li> <li>Shadow DOM —— 为组件创建内部 DOM，它对外部是不可见的</li> <li>CSS Scoping —— 申明仅应用于组件的 Shadow DOM 内的样式</li> <li>Event retargeting 以及更多的小东西，让自定义组件更适用于开发工作</li></ul> <h2 id="custom-elements自定义元素"><a href="#custom-elements自定义元素" class="header-anchor">#</a> Custom Elements自定义元素</h2> <p>可通过描述带有自己的方法、属性和事件等的类来创建自定义 HTML 元素，在 custom elements （自定义标签）定义完成之后，可以将其和 HTML 的内建(原生)标签一同使用，使用方法也与常规 html 标签基本相同。</p> <p>Custom elements 有两种：</p> <ul><li>Autonomous custom elements （自主自定义标签） —— “全新的”元素标签, 继承自<code>HTMLElement</code>抽象类.</li> <li>Customized built-in elements （自定义内建元素） —— 继承内建的 HTML 元素，比如自定义<code>HTMLButtonElement</code>等。</li></ul> <p><strong>IE完全不支持，Safari 不支持自定义内建元素(即在已有元素类型上扩展)。</strong></p> <p>在创建 custom elements 的时候，我们需要告诉浏览器一些细节，包括：如何展示它，以及在添加元素到页面和将其从页面移除的时候需要做什么，等等。这要求声明的类带有几个特殊的方法，<strong>但这些方法都不是必须的</strong>。</p> <p>类的结构和一些特殊方法说明：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这里声明的类相当于对我们创建的自定义html标签的内容、结构、样式及功能描述，类中可以访问外部页面的全局变量</span>
<span class="token keyword">class</span> <span class="token class-name">MyElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 调用 super 方法后才能在constructor中使用继承的父类上的相关属性和方法(若要在构造的时候就是要父类属性和方法)</span>
    <span class="token comment">// 元素在这里创建：内部html内容(包括结构和样式等)，也可以在元素被添加到文档时再创建</span>
    <span class="token comment">// 需要注意，此时访问该自定义元素DOM上相关attribute时为空，因为constructor调用时虽然元素实例化了，但其还未插入文档，所以此时有些内容是无法访问的</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 以下方法中`this`上可以直接访问继承的父类上的相关属性和方法，也可以访问自定义元素上的所有内容(因为这些方法调用时元素已插入文档)</span>

  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在元素被添加到文档之后，浏览器会调用这个方法</span>
    <span class="token comment">//（如果一个元素被反复添加到文档，那么这个方法会被多次调用）</span>
    <span class="token comment">// 需要注意，此时访问元素内容`this.innerHTML`是空的，因为要等当前自定义标签解析完了子内容才会加载进来</span>
    <span class="token comment">// 可通过自定义元素的上的attribute来传参，这些属性获取是实时的</span>
  <span class="token punctuation">}</span>

  <span class="token function">disconnectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在元素从文档移除的时候，浏览器会调用这个方法</span>
    <span class="token comment">// （如果一个元素被反复移除文档，那么这个方法会被多次调用）</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">observedAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token comment">/* 属性数组(指标签上的attribute)，这些属性的变化会被监听 */</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 未监听的属性可能只会在初始化时使用一次，变动时就不会触发内部更改</span>
  <span class="token punctuation">}</span>

  <span class="token function">attributeChangedCallback</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当上面数组中的属性发生变化的时候，这个方法会被调用，上面数组之外的属性变化不会触发该方法</span>
  <span class="token punctuation">}</span>

  <span class="token function">adoptedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在元素被移动到新的文档的时候，这个方法会被调用</span>
    <span class="token comment">// （document.adoptNode 会用到, 非常少见）</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 还可以添加更多的元素自定义方法和属性</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义html标签，第一个参数为标签名(必须包含`-`连接才有效，以便与原生标签区分开)，第二个参数就是上面该标签的描述类</span>
customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;my-element&quot;</span><span class="token punctuation">,</span> MyElement<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// customElements 是一个内置对象(若支持Web Components)</span>
</code></pre></div><p>经过以上操作后(故要在使用前就定义好，否则会被当做未知元素，虽然也不会报错)，当任何带有<code>&lt;my-element&gt;</code>标签的元素被创建的时候，一个<code>MyElement</code>的实例也会被创建，且前面提到的方法也会被调用，包括使用<code>document.createElement('my-element')</code>方法动态创建元素，也即是只要浏览器解析到该元素就会调用相关内容。</p> <p><code>:not(:defined)</code>CSS 选择器可以对「未定义」的未知元素加上样式。</p> <p>可以通过这些方法来获取更多的自定义标签的信息：</p> <ul><li><code>customElements.get(tag)</code> —— 返回指定 custom element tag 的类，也可用于判断指定的 tag 是否已定义</li> <li><code>customElements.whenDefined(tag)</code> – 返回一个 promise，将会在这个具有给定 tag 的 custom element 变为已定义状态的时候 resolve（不带值）</li></ul> <p>示例，创建一个时间格式化显示标签<code>&lt;time-formatted&gt;</code>：</p> <div data-config="" data-type="vanilla" data-code="%3Ctemplate%20id%3D%22tmpl%22%3E%0A%20%20%3Cfrom%3E%0A%20%20%20%20%3Ctable%3E%0A%20%20%20%20%20%20%3Cthead%3E%0A%20%20%20%20%20%20%20%20%3Ctr%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cth%3E%3Cinput%20type%3D%22checkbox%22%20name%3D%22all-checked%22%20value%3D%22all%22%20%2F%3E%3C%2Fth%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cth%3E%E5%A7%93%E5%90%8D%3C%2Fth%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cth%3E%E7%94%B5%E8%AF%9D%3C%2Fth%3E%0A%20%20%20%20%20%20%20%20%3C%2Ftr%3E%0A%20%20%20%20%20%20%3C%2Fthead%3E%0A%20%20%20%20%20%20%3Ctbody%3E%3C%2Ftbody%3E%0A%20%20%20%20%3C%2Ftable%3E%0A%20%20%3C%2Ffrom%3E%0A%3C%2Ftemplate%3E%0A%0AcustomElements.define('my-table'%2C%20class%20extends%20HTMLElement%20%7B%0A%20%20connectedCallback()%20%7B%0A%20%20%20%20this.attachShadow(%7Bmode%3A%20'open'%7D).append(tmpl.content.cloneNode(true))%3B%0A%20%20%20%20this.shadowRoot.querySelectorAll('input%5Bname%3D%22select%22%5D').forEach(checkbox%20%3D%3E%20%7B%0A%20%20%20%20%20%20checkbox.addEventListener('change'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20this.dispatchEvent(new%20CustomEvent('selected'%2C%20%7B%0A%20%20%20%20%20%20%20%20%20%20bubbles%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20composed%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20detail%3A%20%22%E9%80%89%E4%B8%AD%E9%A1%B9%E7%9B%AE%E5%8F%98%E5%8C%96%22%0A%20%20%20%20%20%20%20%20%7D))%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%20%20static%20get%20observedAttributes()%20%7B%0A%20%20%20%20return%20%5B'data'%5D%3B%0A%20%20%7D%0A%20%20attributeChangedCallback(name%2C%20oldValue%2C%20newValue)%20%7B%0A%20%20%20%20if%20(name%20%3D%3D%3D%20'data')%20%7B%0A%20%20%20%20%20%20const%20newTbodyCont%20%3D%20JSON.parse(newValue).map((item)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20return%20%60%3Ctr%3E%0A%20%20%20%20%20%20%20%20%20%20%3Ctd%3E%3Cinput%20type%3D%22checkbox%22%20name%3D%22select%22%20value%3D%22%24%7Bitem.id%7D%22%20%2F%3E%3C%2Ftd%3E%0A%20%20%20%20%20%20%20%20%20%20%3Ctd%3E%24%7Bitem.name%7D%3C%2Ftd%3E%0A%20%20%20%20%20%20%20%20%20%20%3Ctd%3E%24%7Bitem.tel%7D%3C%2Ftd%3E%0A%20%20%20%20%20%20%20%20%3C%2Ftr%3E%60%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20this.shadowRoot.querySelector('tbody').innerHTML%20%3D%20newTbodyCont.join('')%3B%0A%20%20%20%20%20%20this.dispatchEvent(new%20CustomEvent('update'%2C%20%7B%0A%20%20%20%20%20%20%20%20bubbles%3A%20true%2C%0A%20%20%20%20%20%20%20%20composed%3A%20true%2C%0A%20%20%20%20%20%20%20%20detail%3A%20%22%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%22%0A%20%20%20%20%20%20%7D))%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D)%3B%0A%0A%3Cmy-table%20id%3D%22myTable%22%3E%3C%2Fmy-table%3E%0A%0AmyTable.setAttribute('data'%2C%20JSON.stringify(%5B%7Bid%3A%201%2C%20name%3A%20'xxx'%2C%20tel%3A%201770123456789%7D%5D))%3B%0AmyTable.addEventListener('update'%2C%20e%20%3D%3E%20%7B%0A%20%20console.log('%E6%8D%95%E8%8E%B7update%E4%BA%8B%E4%BB%B6%EF%BC%9A'%2C%20e.detail)%3B%0A%7D)%3B%0AmyTable.addEventListener('selected'%2C%20e%20%3D%3E%20%7B%0A%20%20console.log('%E6%8D%95%E8%8E%B7selected%E4%BA%8B%E4%BB%B6%EF%BC%9A'%2C%20e.detail)%3B%0A%7D)%3B%0A" class="vuepress-plugin-demo-block__wrapper" style="display:none;"><div class="vuepress-plugin-demo-block__display"><div class="vuepress-plugin-demo-block__app"></div></div> <div class="vuepress-plugin-demo-block__code"><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">class</span> <span class="token class-name">TimeFormatted</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'datetime'</span><span class="token punctuation">)</span> <span class="token operator">||</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intl<span class="token punctuation">.</span>DateTimeFormat</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>   <span class="token comment">// Intl.DateTimeFormat 是JS内建的时间格式化工具</span>
        year<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'year'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        month<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'month'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        day<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'day'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        hour<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'hour'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        minute<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'minute'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        second<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        timeZoneName<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'time-zone-name'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这里等元素插入文档后再进行相关内容的渲染，因为此时才能获取到元素上的相关 attribute</span>
    <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rendered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rendered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">observedAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 需要监听变化的属性</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'datetime'</span><span class="token punctuation">,</span> <span class="token string">'year'</span><span class="token punctuation">,</span> <span class="token string">'month'</span><span class="token punctuation">,</span> <span class="token string">'day'</span><span class="token punctuation">,</span> <span class="token string">'hour'</span><span class="token punctuation">,</span> <span class="token string">'minute'</span><span class="token punctuation">,</span> <span class="token string">'second'</span><span class="token punctuation">,</span> <span class="token string">'time-zone-name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">attributeChangedCallback</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 受监听属性变化后内容进行重新渲染</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>

  customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;time-formatted&quot;</span><span class="token punctuation">,</span> TimeFormatted<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 改变受监听的属性值，促使元素内容重渲染</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'datetime'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>time-formatted</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>elem<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hour</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>numeric<span class="token punctuation">&quot;</span></span> <span class="token attr-name">minute</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>numeric<span class="token punctuation">&quot;</span></span> <span class="token attr-name">second</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>numeric<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>time-formatted</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></div> <div class="vuepress-plugin-demo-block__footer"></div></div> <h3 id="关于渲染顺序"><a href="#关于渲染顺序" class="header-anchor">#</a> 关于渲染顺序</h3> <p>在 HTML 解析器构建 DOM 的时候，会按照先后顺序处理元素，先处理父级元素再处理子元素。例如，如果我们有<code>&lt;outer&gt;&lt;inner&gt;&lt;/inner&gt;&lt;/outer&gt;</code>(这里<code>&lt;inner&gt;</code>指任何子内容)，那么<code>&lt;outer&gt;</code>元素会首先被创建并接入到 DOM，然后才是<code>&lt;inner&gt;</code>，这对 custom elements 就会产生影响，若在<code>&lt;outer&gt;</code>的<code>connectedCallback</code>中访问其<code>innerHTML</code>就将得到空内容，因为此时<code>&lt;inner&gt;</code>还未加载进来。</p> <p>若我们要给 custom element 传入信息，我们可以使用元素属性，<strong>元素属性是即时生效的</strong>。</p> <p>若需要访问子元素，可以在<code>connectedCallback</code>中<strong>使用延迟时间为零的<code>setTimeout</code>来推迟访问子元素</strong>，因 HTML 解析完成之后，才异步执行<code>setTimeout</code>这段程序，我们在这个时候处理必要的子元素并且结束初始化过程，但这个方案并不完美，若嵌套的 custom element 同样使用了<code>setTimeout</code>来初始化自身，那么它们会按照先后顺序执行：外层的<code>setTimeout</code>首先触发，然后才是内层的，这样外层元素还是早于内层元素结束初始化。</p> <h3 id="扩展内建-原生-元素"><a href="#扩展内建-原生-元素" class="header-anchor">#</a> 扩展内建(原生)元素</h3> <p>上面创建的自定义元素没有语义，因为其继承的<code>HTMLElement</code>类，是通用元素类。要创建具有语义的自定义元素，可以让其从具有语义的类上继承（看作是对原生标签能力的扩展更适合），如创建自定义按钮，可以让其从<code>HTMLButtonElement</code>类上继承。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyButton</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLButtonElement</span> <span class="token punctuation">{</span> <span class="token comment">/* custom element 方法 */</span> <span class="token punctuation">}</span>

<span class="token comment">// 传入第三个参数，表示扩展自 button 元素，这一步是必须的，因为不同的标签会共享同一个类</span>
customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'my-button'</span><span class="token punctuation">,</span> MyButton<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">extends</span><span class="token operator">:</span> <span class="token string">'button'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用方法略有不同，仍然使用普通的 &lt;button&gt; 标签(包含其所有使用方法)，但添加 is=&quot;hello-button&quot; 属性指明是自定义的扩展元素(就还可以使用扩展内容)</span>
<span class="token operator">&lt;</span>button is<span class="token operator">=</span><span class="token string">&quot;hello-button&quot;</span><span class="token operator">&gt;</span>扩展按钮<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>button is<span class="token operator">=</span><span class="token string">&quot;hello-button&quot;</span> disabled<span class="token operator">&gt;</span>禁用按钮<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
</code></pre></div><h2 id="shadow-dom-内部影子dom"><a href="#shadow-dom-内部影子dom" class="header-anchor">#</a> Shadow DOM 内部影子DOM</h2> <p>Shadow DOM 可以让一个组件拥有自己的「影子」DOM 树，这个 DOM 树不在主文档html中显示，且其可能拥有局部样式规则，还有其他特性，外界是无法随意访问的。</p> <p>一个DOM元素可以有两类DOM子树：</p> <ol><li>Light tree（光明树） —— 一个常规 DOM 子树，由 HTML 子元素组成，通常情况下看到的所有子树都是「光明的」</li> <li>Shadow tree（影子树） —— 一个隐藏的 DOM 子树，不在 HTML 中反映，无法被察觉</li></ol> <p>如果一个元素同时有以上两种子树，那么浏览器只渲染 shadow tree，但是我们同样可以设置两种树的组合，这要使用到后面介绍的 Shadow DOM 插槽。</p> <p>Shadow DOM 可以在自定义元素中被使用，其作用是隐藏组件内部结构和添加只在组件内有效的样式，但不是所有自定义元素都可以使用Shadow DOM，对于扩展build-in内置元素的就只有部分元素可用，其使用有两个条件：</p> <ol><li>在每个元素中，我们只能创建一个 shadow root；</li> <li>必须是自定义元素，或者是扩展以下内建元素中的一个：div、p、section、span、h1…h6、header、footer、main、nav、article、aside、blockquote、body，其他元素，比如<code>&lt;img&gt;</code>/<code>&lt;button&gt;</code>，就不能容纳 shadow tree。</li></ol> <p>创建 Shadow DOM 的方法如下：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'show-hello'</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> HTMLElement <span class="token punctuation">{</span>
  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 attachShadow 方法可以创建一个 shadow tree， 其返回一个 shadow root，就像元素DOM节点一样</span>
    <span class="token keyword">const</span> shadow <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>mode<span class="token operator">:</span> <span class="token string">'open'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shadow<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;
      Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    &lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* html 中使用该自定义标签 */</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>show-hello</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>John<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>show-hello</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>attachShadow({ mode: open|closed })</code>方法创建一个 shadow tree， 其返回一个 shadow root 节点，就像元素DOM节点一样，可以使用DOM相关方法：</p> <p>参数<code>mode</code>选项可以设定封装层级，其有两个值可选：</p> <ul><li><code>open</code>，表示打开外部对 shadow tree 的访问，此时通过<code>el.shadowRoot</code>可访问影子树的根节点，任何代码也都可以访问元素<code>el</code>的 shadow tree，还可以做各种DOM操作
<ul><li>注意：这里的可访问只是从 DOM 属性上可访问，并非是主文档HTML结构上直接可见，像外部的 light DOM 光明树中调用<code>querySelector</code>是无法查找影子树内部的，影子树内部只能在<code>shadowRoot</code>内部查找</li></ul></li> <li><code>closed</code>，表示关闭影子树的访问，此时<code>el.shadowRoot</code>永远是<code>null</code></li></ul> <p>Shadow DOM 有自己的样式，外部样式规则在 Shadow DOM 中无效（<strong>但内部可以使用外部的CSS变量</strong>），可以在 Shadow DOM 中插入<code>&lt;style&gt;</code>标签定义内部相关样式，也可以直接写在行内。</p> <p>具有 shadow root 的元素叫做「shadow tree host」，可以通过<code>shadowRoot.host</code> 属性访问(也即是元素自身)：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 假设自定元素 el 的 mode 为 open</span>
el<span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span>host <span class="token operator">===</span> el<span class="token punctuation">;</span>  <span class="token comment">// true</span>
</code></pre></div><p><b style="color:orange;">注意：</b>只要满足上面创建 shadow tree 的两个条件的元素，都可以调用<code>attachShadow</code>创建 shadow tree（只是创建shadow tree，类中的其他方法是不能设置的），<strong>并非只能在创建自定义元素的类中使用</strong>，但也需注意这样创建的 shadow tree 将导致元素中原来的内容默认不显示(但内容仍在，因形成shadowDOM后未设置插槽)，通过向其中插入<code>&lt;slot&gt;</code>节点可使原来的内容也显示出来(此时原内容就被放入默认插槽中)。</p> <h2 id="模板元素-template"><a href="#模板元素-template" class="header-anchor">#</a> 模板元素 template</h2> <p>HTML内建的<code>&lt;template&gt;</code>元素用来存储 HTML 模板，浏览器会忽略它的内容执行，仅检查语法的有效性，但我们可在 JS 中访问和使用它来创建其他元素或内容，这些内容只要插入到文档主体结构中才会被激活正常执行，也即是可以按 HTML 逻辑储存代码段(非字符串形式)但又不让他们立即执行，当插入文档其他普通地方时才会执行。</p> <p>相比其他随便创建一个隐藏元素来么存储HTML模板，<code>&lt;template&gt;</code>元素主要有以下有点：</p> <ul><li>其内容可以是任何有效的HTML片段，就像一个html文件内容一样，且其是原样保存，不像在一个隐藏的<code>div</code>中一些特定的html结构错误了会被浏览器自动修复，导致破坏我们想要的结果(如<code>table/tr/td</code>、<code>ul/li</code>等)（若只是原样保存则<code>&lt;script type=&quot;text/html&quot;&gt;</code>也可以做到）</li> <li>浏览器会认为<code>&lt;template&gt;</code>中的内容不在文档中，也就不会对齐进行解析执行，即样式不会被应用，脚本不会被执行，html元素也不会按原本的方式展示生效，但是当把这些内容插入文档是，这些内容就会变为激活状态而正确应用</li></ul> <h3 id="插入模板内容"><a href="#插入模板内容" class="header-anchor">#</a> 插入模板内容</h3> <p>模板DOM的<code>content</code>属性返回一个<a href="https://zh.javascript.info/modifying-document#document-fragment" target="_blank" rel="noopener noreferrer">DocumentFragment<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>节点（文档片段节点，并非文本，类似<code>document</code>对象，可看作一个特殊的DOM节点），它有一个特殊特性：将其插入没某个位置时，会被插入的是其子节点，而不包含节点自身(从属性名就知道只是内容)。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tmpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css"> <span class="token selector">.msg</span> <span class="token punctuation">{</span> <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span> <span class="token punctuation">}</span> </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>message<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>el<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>按钮<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  el<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 template 存储的代码片段，在已有元素中创建 shadow tree</span>
    el<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>mode<span class="token operator">:</span> <span class="token string">'open'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从页面模板中获取预设的内容并克隆一份应用到自定义元素的 shadow tree 中</span>
    el<span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    el<span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&quot;Hello from the shadows!&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>点击上面的<code>&lt;div id=&quot;el&quot;&gt;按钮&lt;/div&gt;</code>后，其就会变成如下形式的 Shadow DOM：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>el<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  #shadow-root
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css"> <span class="token selector">.msg</span> <span class="token punctuation">{</span> <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span> <span class="token punctuation">}</span> </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>message<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello from the shadows!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上面提到的将 shadow tree 内容预存在页面<code>&lt;template&gt;</code>模板中的方式从组件库封装层面来说并合适，因为未将组件本身与页面分离开使得组件不可独立使用在其他地方，要使组件可以独立使用就需要将<code>customElements</code>的所有内容都封装在js文件中，我们可以使用<code>createElement</code>动态创建<code>&lt;template&gt;</code>元素并写入模板内容使用，但这样实际与直接使用<code>shadowRoot.innerHTML</code>写入 shadow tree 也没多大区别了。</p> <h2 id="shadow-dom-插槽-组成"><a href="#shadow-dom-插槽-组成" class="header-anchor">#</a> Shadow DOM 插槽/组成</h2> <p>Shadow DOM 支持<code>&lt;slot&gt;</code>插槽元素，可传入 light DOM 中的内容自动填充(<strong>只是渲染到其中，DOM并未进行实际的移动</strong>)，定义和使用方式同 Vue 中插槽类似，当 Shadow DOM 中没有设置插槽时则外部的 light DOM 是无法在自定义元素中显示的(除非是扩展的内建元素)。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user-card'</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> HTMLElement <span class="token punctuation">{</span>
    <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'open'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;div&gt;Name:
          // 具名插槽，在 slot 元素上通过 name 属性定义该插槽名字
          &lt;slot name=&quot;username&quot;&gt;&lt;/slot&gt;
        &lt;/div&gt;
        &lt;div&gt;Birthday:
          &lt;slot name=&quot;birthday&quot;&gt;
            &lt;span&gt;1月1日&lt;/span&gt; // 插槽默认内容，当未向该插槽传入内容时将显示该默认内容
          &lt;/slot&gt;
        &lt;/div&gt;
        &lt;div&gt;Age:
          // 默认插槽， 不定义插槽名字，此时未指定传入哪个插槽的内容都会传入该位置
          &lt;slot&gt;&lt;/slot&gt;
        &lt;/div&gt;
      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'slot[name=&quot;username&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// this 会指向当前绑定事件的 &lt;slot&gt; 元素（不会包含传入的插槽内容，属于内部 Shadow DOM 内容，无法向上找到外部 light DOM 去，故无法内外比较）</span>
        <span class="token comment">// e.target 在事件代理中会指向实际触发事件的传入插槽的 light DOM 中的元素（属于外部文档中的 light DOM内容，无法向内找到 Shadow DOM 内部去）</span>
        <span class="token comment">// root 也就是外部的 this 指向文档中实际应用的 &lt;user-card&gt; 标签DOM（属于外部文档中的 light DOM 内容，无法向内找到 Shadow DOM 内部去）</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 由于这里是在 shadowRoot 下也就是组件 shadow DOM 内部进行的事件绑定，故 e.target 也可以指向组件内实际元素，</span>
        <span class="token comment">// 但若是外部非 shadowRoot 下绑定事件且非传入插槽中的 light DOM 上触发的事件，则只会抛出自定义元素&lt;user-card&gt;这一层，这也符合使用预期，因为组件化的意义就是外部不需要知道组件内部的情况</span>
        <span class="token comment">// 也即是外部文档绑定的事件 e.target 只能指向文档 light DOM 可见的元素，而 shadowRoot 内部绑定的事件 e.target 还可以具体指向组件内部才可见的更深的元素</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 并没有要求传入同一插槽的内容要包裹在一个标签中，可以分开指向同一插槽，其会被组合插入到同一名字的插槽中 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user-card</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 在元素上通过 slot 属性指明当前元素应该被放入哪个插槽 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>姓名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 没有 slot 属性指明的则方法默认插槽(若有) --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>年龄18岁<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 多个指向同名插槽的会被插入同一插槽中 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>姓名2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>年龄19岁<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 没有对应插槽的将不会被传入 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nickname<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>昵称<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user-card</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>被渲染到插槽中的结果被叫做扁平化（flattened）DOM（控制台中若有打开显示shadow DOM则可以看到），<strong>但 flattened DOM 被创建仅仅是用来渲染和事件处理的，是“虚拟”的， Shadow DOM 中是无法查找它们的</strong>，虽然是渲染出来了，但传入的<strong>节点实际并未做任何移动</strong>，调用<code>querySelectorAll</code>可看到节点位置仍在原处(故 Shadow DOM 中虽然渲染了也仍是无法查找到DOM，但可以查找到<code>&lt;slot&gt;</code>元素使用，事件绑定效果与应用在传入的 light DOM 顶层上一样)。</p> <p>因此，扁平化 DOM 是通过插入插槽从 shadow DOM 派生出来的，浏览器渲染它并且<strong>用于(从外部文档)样式继承、事件传播</strong>，但是 JS 在扁平前仍可按原样看到文档，Shadow DOM 中无法查找到这部分实际文档。</p> <p><b style="color:orange;">注意：</b>针对某个确定自定义元素而言，只有顶层子元素可以使用<code>slot</code>属性指明要放入的插槽(若有定义，但插槽是可以定义在Shadow DOM的常规html中任何位置的)，其他后代元素使用是无效的，这很好理解，也即是<strong>所有插槽生效与否都是针对其父元素而言的</strong>。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user-card</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>姓名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- &lt;user-card&gt; 的子元素，且有 username 这个插槽，所以有效 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- &lt;user-card&gt; 的子元素，会被放入默认插槽，包括其内部 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>birthday<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>10月1日<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 这是 &lt;div&gt; 的子元素，显然无法使用插槽，故无效，但因层级关系其会跟随父元素被放入默认插槽 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>card-item</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 同上面 &lt;div&gt; 情况 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>age<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>18岁<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 这是 &lt;card-item&gt; 的子元素，该插槽是否有效要看 &lt;card-item&gt; 元素是否有定义该插槽，但对 &lt;user-card&gt; 而言即使其有定义该插槽这里对其也是无效的 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>card-item</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user-card</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="插槽事件与api"><a href="#插槽事件与api" class="header-anchor">#</a> 插槽事件与API</h3> <p><strong>添加/删除/替代</strong>了插槽元素，浏览器将监听到插槽变动并更新渲染，触发<code>slotchange</code>事件，但是也只会是前面提到的添加、删除和替代插槽时才会触发，对于已插入插槽的 light DOM 内容进行修改虽然效果上会变动但是不会触发该事件的，若要跟踪 light DOM 内部的修改，则可使用更通用的DOM变动观察机制<a href="https://zh.javascript.info/mutation-observer" target="_blank" rel="noopener noreferrer">MutationObserver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>如前面的介绍 JS 会查看真实的 DOM，而不展开 Shadow DOM，但是若 shadow 树有<code>{mode: 'open'}</code> ，那么我们可以通过下面的一些API判断一个节点被放进了哪个插槽以及一个插槽下插入了哪些节点：</p> <ul><li><code>node.assignedSlot</code>，返回<code>node</code>节点被插入到的<code>&lt;slot&gt;</code>元素或<code>null</code>(没有相应插槽时)；</li> <li><code>slot.assignedNodes({flatten: true|false})</code>， 返回当前<code>slot</code>插槽中插入的 DOM 节点。默认情况下，<code>flatten</code>选项为<code>false</code>，若显式地设置为<code>true</code>，则它将更深入地查看扁平化 DOM（结果来看似乎没区别？）。若嵌套了组件，则也会返回嵌套的插槽，如果未分配节点，则返回该插槽默认内容；</li> <li><code>slot.assignedElements({flatten: true|false})</code>，返回当前<code>slot</code>插槽中插入的 DOM 元素集合（与上面相同，但仅元素节点）</li></ul> <p>以自定义菜单栏为例：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'custom-menu'</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> HTMLElement <span class="token punctuation">{</span>
  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'open'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;div class=&quot;menu&quot;&gt;
        &lt;slot name=&quot;title&quot;&gt;&lt;/slot&gt;
        &lt;ul&gt;&lt;slot name=&quot;item&quot;&gt;&lt;/slot&gt;&lt;/ul&gt;
      &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token comment">// shadowRoot 不能进行事件绑定，故将事件绑定在其第一个子元素 div 上（由于这里整个 shadow tree 是 div 标签包裹的，也相当于是绑定到了根节点上）</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span>firstElementChild<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'slotchange'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> slot <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;slotchange: &quot;</span> <span class="token operator">+</span> slot<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'item'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>slot<span class="token punctuation">.</span><span class="token function">assignedElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 与保存的历史长度进行比较即可判断是插入/移除/替换</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  menu<span class="token punctuation">.</span><span class="token function">insertAdjacentHTML</span><span class="token punctuation">(</span><span class="token string">'beforeEnd'</span><span class="token punctuation">,</span> <span class="token string">'&lt;li slot=&quot;item&quot;&gt;子菜单item2&lt;/li&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* (3) 插入 */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> title <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'[slot=&quot;title&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  title<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&quot;新菜单头&quot;</span><span class="token punctuation">;</span>  <span class="token comment">/* (4) 不会触发 slotchange */</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>title<span class="token punctuation">.</span>assignedSlot<span class="token operator">?.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 若是使用以下替代插槽节点的方式则会触发 slotchange 事件</span>
  <span class="token comment">/* var newTitle = document.createElement('h3');
  newTitle.append('新菜单头');
  newTitle.slot = 'title';  // slot 为标签原生支持属性，故可直接访问
  menu.replaceChild(newTitle, menu.querySelector('[slot=&quot;title&quot;]')); */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  menu<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'[slot=&quot;item&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* (5) 移除 */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>custom-menu</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>menu<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">菜单头</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">  /* (1) */
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">子菜单item1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">  /* (2) */
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>custom-menu</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>以上示例将触发4次<code>slotchange</code>事件：</p> <ol><li>初始化<code>(1)</code>时：<code>slotchange: title</code>立即触发，因为来自 light DOM 的<code>slot=&quot;title&quot;菜单头</code>进入了相应的插槽；</li> <li>初始化<code>(2)</code>时：<code>slotchange: item</code>立即触发，因为来自 light DOM 的<code>slot=&quot;item&quot;子菜单item1</code>进入了相应的插槽；</li> <li>1s后：<code>slotchange: item</code>触发，因为<code>(3)</code>将新的<code>slot=&quot;item&quot;子菜单item2</code>插入了相应的插槽；</li> <li>2s后<code>(4)</code>不会触发<code>slotchange</code>事件，因为其是修改已进入插槽的内容，虽会引起原始位置DOM内容变动也会使插槽内容跟着显示变化，但并不会触发<code>slotchange</code>事件；</li> <li>3s后：<code>slotchange: item</code>触发，因为<code>(5)</code>将<code>slot=&quot;item&quot;子菜单item1</code>从相应的插槽中移除了；</li></ol> <h2 id="给-shadow-dom-添加样式"><a href="#给-shadow-dom-添加样式" class="header-anchor">#</a> 给 Shadow DOM 添加样式</h2> <p>shadow DOM 可以包含<code>&lt;style&gt;</code>和<code>&lt;link rel=&quot;stylesheet&quot; href=&quot;url&quot;&gt;</code>标签来在内部应用样式，但须注意<code>&lt;link&gt;</code>的外部样式文件与使用该组件的文件的相对路径并非固定，从组件库层面来说也不能满足所有项目所有场景下都有统一的绝对路径，所以这种引入样式的方式使用场景很受限，较少使用(但其做到了样式分离，且也不会每应用一次组件就声明一份样式)。</p> <h3 id="host选择器"><a href="#host选择器" class="header-anchor">#</a> :host选择器</h3> <p><code>:host</code>选择器允许选择 <strong>shadow 宿主(即自定义元素本身)</strong>，由于自定义元素本身是在 light DOM 中使用的，所以其也受外部文档样式的影响，且同样的属性外部文档样式优先级要高于<code>:host</code>选择器中的对应属性(使得我们可以在内部定义默认样式，而通过外部个性化修改，但除可继承属性外这些应用也只能在自定义元素这一层而不包含 shadow DOM 内部其他元素)，<strong>但若内部属性有添加<code>!important</code>，则始终是内部该属性优先级最高</strong>。这里提到的CSS优先级原则同样适用于后面介绍的<code>:host()</code>和<code>:host-context()</code>。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tmpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- shadow DOM 内部样式 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token comment">/* :host 中的样式将从内部应用到 custom-dialog 元素上(可以看作是用在根元素上，但实际又不是根元素) */</span>
    <span class="token selector">:host</span> <span class="token punctuation">{</span>
      <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
      <span class="token property">text-align</span><span class="token punctuation">:</span> center <span class="token important">!important</span><span class="token punctuation">;</span>  <span class="token comment">/* 内部只要加了 !important，优先级就最高，不管外部是否综合CSS优先级更高*/</span>
      <span class="token comment">/* more css... */</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'custom-dialog'</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> HTMLElement <span class="token punctuation">{</span>
  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>mode<span class="token operator">:</span> <span class="token string">'open'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 外部文档样式 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">custom-dialog</span> <span class="token punctuation">{</span>
      <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>  <span class="token comment">/* 会覆盖元素 :host 内部的 */</span>
      <span class="token property">text-align</span><span class="token punctuation">:</span> left <span class="token important">!important</span><span class="token punctuation">;</span> <span class="token comment">/* 不会覆盖元素 :host 内部的，因内部加了 !important 优先级更高*/</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="host-选择器"><a href="#host-选择器" class="header-anchor">#</a> :host()选择器</h3> <p>与<code>:host</code>相同，但需要同时满足 shadow 宿主与括号中的选择器也匹配时才能算完全匹配。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tmpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token comment">/* 默认样式 */</span>
    <span class="token selector">:host</span> <span class="token punctuation">{</span>
      <span class="token property">text-align</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 条件样式 */</span>
    <span class="token selector">:host([center])</span> <span class="token punctuation">{</span>
      <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>custom-dialog</span><span class="token punctuation">&gt;</span></span>默认居右<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>custom-dialog</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>custom-dialog</span> <span class="token attr-name">center</span><span class="token punctuation">&gt;</span></span>添加center属性居中<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>custom-dialog</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="host-context-选择器"><a href="#host-context-选择器" class="header-anchor">#</a> :host-context()选择器</h3> <p>与<code>:host()</code>类似，但其条件更宽松，当外部文档中的 shadow 宿主或它的任何祖先元素与括号中的选择器匹配时就算完全匹配，将条件由自身扩大到了祖先(context字面意思上下文也可理解)。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tmpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">:host-context([theme-dark])</span> <span class="token punctuation">{</span>
      <span class="token property">background</span><span class="token punctuation">:</span> black<span class="token punctuation">;</span>
      <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>custom-dialog</span> <span class="token attr-name">theme-dark</span><span class="token punctuation">&gt;</span></span>可匹配<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>custom-dialog</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">theme-dark</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>custom-dialog</span><span class="token punctuation">&gt;</span></span>也可匹配<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>custom-dialog</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="插槽内容样式及-slotted"><a href="#插槽内容样式及-slotted" class="header-anchor">#</a> 插槽内容样式及::slotted()</h3> <p>因插槽内容实际是属于外部 light DOM 的，只是渲染到插槽中的而已，故其样式是由外部文档样式决定的，不受内部样式的影响，这也符合我们自定义插槽内容的使用预期。</p> <p>若想在组件内部设置插槽内容的样式，则有两种途径，但他们能做的也都比较有限：</p> <ol><li>方式一：可以在组件内部直接对<code>&lt;slot&gt;</code>元素进行样式设置，样式实际是作用在<code>&lt;slot&gt;</code>元素上，但由于CSS存在继承特性，部分可继承的样式就会在<code>&lt;slot&gt;</code>和它的内容之间有效，之所以是一部分也是因为并非所有CSS都会有继承关系(除显式声明某属性值为<code>inherit</code>)，所以可用的有限，且外部插槽内容样式随时都可覆盖；</li> <li>方式二：使用<code>::slotted()</code>伪类，其有效匹配条件是该元素是来自 light DOM 的顶层插槽内容，且其可匹配括号中的选择器，注意该伪类整体或其括号内都不能结合层级关系选择器使用；</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tmpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">slot</span> <span class="token punctuation">{</span>
      <span class="token property">color</span><span class="token punctuation">:</span> gray<span class="token punctuation">;</span> <span class="token comment">/* 由于字体颜色是可继承的，故所有插槽内容都会应用，除非优先级被覆盖 */</span>
    <span class="token punctuation">}</span>
    <span class="token selector">slot[name=&quot;age&quot;]</span> <span class="token punctuation">{</span>  <span class="token comment">/* 匹配名为 age 的 slot 元素 */</span>
      <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">::slotted(section)</span> <span class="token punctuation">{</span>  <span class="token comment">/* 匹配传入的插槽内容根元素为 section 的元素 */</span>
      <span class="token property">color</span><span class="token punctuation">:</span> orange<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">[name=&quot;birthday&quot;]::slotted([skyblue])</span> <span class="token punctuation">{</span>  <span class="token comment">/* 匹配名为 birthday 的 slot 元素，且传入的插槽内容根元素具备 skyblue 属性 */</span>
      <span class="token property">color</span><span class="token punctuation">:</span> skyblue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 以下两种使用方式都无效，因为使用了层级关系选择器 */</span>
    <span class="token selector">::slotted(div span)</span> <span class="token punctuation">{</span><span class="token comment">/* 无效 */</span> <span class="token punctuation">}</span>
    <span class="token selector">::slotted(div) p</span> <span class="token punctuation">{</span><span class="token comment">/* 无效 */</span> <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>age<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>birthday<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user-card</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    姓名：
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>佚名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>age<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    年龄：
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>18岁<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>birthday<span class="token punctuation">&quot;</span></span> <span class="token attr-name">skyblue</span><span class="token punctuation">&gt;</span></span>
    生日：
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>10月1日<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user-card</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><b style="color:orange;">注意：</b><code>preSelector::slotted(selector)</code>用法中的前置选择器 preSelector 匹配是针对 shadow DOM 内部结构的，而括号中的条件选择器 selector 匹配是针对传入插槽的 light DOM 外部结构的，包括前面介绍的<code>:host()</code>和<code>:host-context()</code>的括号中的条件选择器也是一样的。此外，<code>::sloated()</code> 只能在 CSS 中使用，不能在类似<code>querySelector</code>的JS API中使用。</p> <h3 id="使用自定义css变量传递样式"><a href="#使用自定义css变量传递样式" class="header-anchor">#</a> 使用自定义CSS变量传递样式</h3> <p>前面提到的选择器和样式修改方案也都是外部对组件的根节点有影响，顶多也只是继承特性对内部有点深入，但影响太小。</p> <p>若想让外部的设置更加深入的影响组件内部 shadow DOM 元素的样式，有两种方法：</p> <ol><li>可通过在元素标签上设置属性传参的方式使组件内部根据参数应用不同样式甚至 DOM 结构，但这种方式最好是使用在组件的功能性特点切换或DOM结构有变化的场景，因为其相对来说更复杂；</li> <li>纯样式方面，可以通过内部预设的 CSS 变量来覆盖相关的属性值，在外部修改 CSS 变量值即可在内部生效应用，<strong>因为 CSS 变量是可以穿透 shadow DOM 的，外部的 CSS 变量在组件内部也是可以使用的</strong>，局限就是只能是内部有预设的才可改变，要可更改的越多，预设的就要越多；</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tmpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">.w-title</span> <span class="token punctuation">{</span>
      <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--w-color-danger<span class="token punctuation">,</span> red<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* 若预设变量值没有或无效，则应用第二个默认值 */</span>
    <span class="token punctuation">}</span>
    <span class="token selector">:host([theme-dark]) .item</span> <span class="token punctuation">{</span>  <span class="token comment">/* 通过外部标签属性单独只设置内部样式，主要针对统一规范或状态调整的 */</span>
      <span class="token property">background</span><span class="token punctuation">:</span> black<span class="token punctuation">;</span>
      <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>w-title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>姓名：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 直接在自定义元素上重置变量值，父元素也是可的，只要在有效作用域内能应用到就行 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user-card</span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">--w-color-danger</span><span class="token punctuation">:</span> #f00<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>佚名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user-card</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token comment">/* style 中声明，或使用单独的主题变量css文件，只要在有效作用域内能应用到就行 */</span>
  <span class="token selector">:root</span> <span class="token punctuation">{</span>
    <span class="token property">--w-color-danger</span><span class="token punctuation">:</span> pink<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="shadow-dom-与事件"><a href="#shadow-dom-与事件" class="header-anchor">#</a> Shadow DOM 与事件</h2> <p>如前面 <a href="#shadow-dom-%E6%8F%92%E6%A7%BD-%E7%BB%84%E6%88%90">Shadow DOM 插槽/组成</a> 一节示例中提到的一样：</p> <ul><li><code>shadowRoot</code>下内部事件处理程序中<code>event.target</code>目标元素可指向 shadow DOM 中的内部深层元素，也可指向传入插槽<code>&lt;slot&gt;</code>中的 light DOM 元素；</li> <li>外部文档中的事件处理程序中<code>event.target</code>目标元素只能指向自定义元素本身或是传入插槽的 light DOM 元素(即外部文档可查询的元素)，不会指向组件内其他的私有元素；</li> <li>对于传入插槽的 light DOM 元素，不管是内部事件处理程序，还是外部事件处理程序，只要是它们身上触发的，<code>event.target</code>都可以准确反映出来；</li></ul> <p>以上特点也符合使用预期，因为组件化的意义就是外部不需要知道组件内部的情况。</p> <h3 id="shadow-dom-事件冒泡"><a href="#shadow-dom-事件冒泡" class="header-anchor">#</a> Shadow DOM 事件冒泡</h3> <p>若有一个<code>&lt;slot&gt;</code>元素，并且事件发生在它的内部某个地方，那么该事件(对于会冒泡的事件)就会冒泡到<code>&lt;slot&gt;</code>并继续向上冒泡，可以使用<code>event.composedPath()</code>方法(事件对象上的通用方法，IE不支持)获取到原始事件的完整冒泡路径(包括 shadow DOM 中的元素)，从该方法字面意思就可知该路径是组合(计算)过后(扁平化 DOM)的最终结果。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user-card'</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> HTMLElement <span class="token punctuation">{</span>
  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>mode<span class="token operator">:</span> <span class="token string">'open'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div&gt;
      &lt;b&gt;Name:&lt;/b&gt;
      &lt;slot name=&quot;username&quot;&gt;&lt;/slot&gt;
    &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span>firstElementChild<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;组件内部: &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">composedPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 对于发生在 &lt;span slot=&quot;username&quot;&gt; 上的点击事件，composedPath冒泡路径结果：</span>
      <span class="token comment">// [span, slot, div, document-fragment(shadow-root), user-card, body, html, document, window]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;外部文档: &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">composedPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// composedPath结果同上</span>

<span class="token comment">/* 外部文档中 light DOM */</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user-card</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userCard<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">用户名</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user-card</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">/* 以上扁平化后的 DOM 结构如下 */</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user-card</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userCard<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  #shadow-root
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Name:</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">用户名</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user-card</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>注意：</strong> 当创建 shadow DOM 是<code>{mode: 'open'}</code>时<code>event.composedPath()</code>中才会包含 shadow tree 详细信息，若是<code>{mode: 'closed'}</code>则组合路径只会从 host 开始：<code>&lt;user-card&gt;</code>及其更上层。</p> <h3 id="event-composed"><a href="#event-composed" class="header-anchor">#</a> event.composed</h3> <p>大多数事件能成功冒泡到 shadow DOM 边界。很少有事件不能冒泡到 shadow DOM 边界。这由<code>composed</code>事件对象属性控制，若<code>composed</code>是<code>true</code>，则事件就能穿过边界(即往上层冒泡)，否则它仅能在 shadow DOM 内部捕获。</p> <p>大部分UI事件都是<code>composed: true</code>可冒泡的：</p> <ul><li>blur，focus，focusin，focusout，</li> <li>click，dblclick，</li> <li>mousedown，mouseup mousemove，mouseout，mouseover，</li> <li>wheel，</li> <li>beforeinput，input，keydown，keyup。</li></ul> <p>所有触摸事件（touch events）及指针事件（pointer events）都是<code>composed: true</code>和冒泡的。</p> <p>但也有些事件是<code>composed: false</code>不可冒泡的：</p> <ul><li>mouseenter，mouseleave（它们根本不会冒泡），</li> <li>load，unload，abort，error，</li> <li>select，</li> <li>slotchange。</li></ul> <p>以上这些不会冒泡的事件仅能设置在事件目标元素DOM上捕获（也即是绑定事件的DOM元素与<code>event.target</code>为同一元素才可捕获到）。</p> <h3 id="customevent-自定义事件"><a href="#customevent-自定义事件" class="header-anchor">#</a> CustomEvent 自定义事件</h3> <p>当我们<code>dispatchEvent</code>主动触发自定义事件时，我们需要设置<code>bubbles</code>和<code>composed</code>属性都为<code>true</code>以使其可冒泡并从组件中冒泡出来以便被外部文档捕获。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tmpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>from</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thead</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>all-checked<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>all<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">姓名</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">电话</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thead</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tbody</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tbody</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>from</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'my-table'</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> HTMLElement <span class="token punctuation">{</span>
  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>mode<span class="token operator">:</span> <span class="token string">'open'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'input[name=&quot;select&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">checkbox</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      checkbox<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomEvent</span><span class="token punctuation">(</span><span class="token string">'selected'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          bubbles<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          composed<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          detail<span class="token operator">:</span> <span class="token string">&quot;选中项目变化&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">observedAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">attributeChangedCallback</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'data'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newTbodyCont <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;tr&gt;
          &lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;select&quot; value=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; /&gt;&lt;/td&gt;
          &lt;td&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/td&gt;
          &lt;td&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>tel<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/td&gt;
        &lt;/tr&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'tbody'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> newTbodyCont<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomEvent</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        bubbles<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        composed<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        detail<span class="token operator">:</span> <span class="token string">&quot;数据更新&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-table</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myTable<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>my-table</span><span class="token punctuation">&gt;</span></span>

myTable<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span> tel<span class="token operator">:</span> <span class="token number">1770123456789</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myTable<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获update事件：'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myTable<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'selected'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获selected事件：'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/js/事件Event.html" class="prev">
        事件Event
      </a></span> <span class="next"><a href="/docs/js/File文件API.html">
        File文件API
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/docs/assets/js/app.1b6c3a36.js" defer></script><script src="/docs/assets/js/2.3ed89261.js" defer></script><script src="/docs/assets/js/32.ff30ecee.js" defer></script>
  </body>
</html>
